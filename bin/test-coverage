#!/usr/bin/env bash
#
# Smart test coverage wrapper
# Automatically uses PHP 8.4 with PCOV if available, otherwise runs tests without coverage
#

set -e

# Check if we're on PHP 8.4 with PCOV
if php -m 2>/dev/null | grep -q pcov; then
    # PCOV available - run with coverage
    vendor/bin/phpunit --coverage-html coverage --coverage-text "$@"
else
    # No coverage driver - check if PHP 8.4 is available via Herd
    if command -v herd >/dev/null 2>&1; then
        echo "ℹ️  Switching to PHP 8.4 for coverage support..."
        # Temporarily switch to PHP 8.4, run tests, then switch back
        CURRENT_PHP=$(php -r "echo PHP_MAJOR_VERSION . '.' . PHP_MINOR_VERSION;")
        herd use 8.4 >/dev/null 2>&1
        vendor/bin/phpunit --coverage-html coverage --coverage-text "$@"
        EXIT_CODE=$?
        herd use "$CURRENT_PHP" >/dev/null 2>&1
        exit $EXIT_CODE
    else
        echo "⚠️  No coverage driver available. Running tests without coverage..."
        vendor/bin/phpunit --no-coverage "$@"
    fi
fi
