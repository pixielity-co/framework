name: Stage 2.5 - Advanced Quality

on:
  workflow_run:
    workflows: ["Stage 2 - Static Analysis"]
    types: [completed]

jobs:
  mutation_testing:
    name: Mutation Testing (Infection)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: mbstring, dom, pdo, sqlite
          coverage: xdebug

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run Infection
        # We use --logger-github to report directly in PRs
        run: |
          composer require --dev infection/infection
          ./vendor/bin/infection --threads=4 --min-msi=80 --logger-github

  notify:
    needs: mutation_testing
    if: always()
    uses: ./.github/workflows/notifications.yml
    with:
      stage_name: "Mutation Testing"
      status: ${{ needs.mutation_testing.result }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
