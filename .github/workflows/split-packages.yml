name: ğŸ”€ Split Packages

on:
  push:
    branches: [main]
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  split-packages:
    name: ğŸ”€ Split Monorepo
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        package:
          - name: contracts
            path: src/Contracts
            repo: git@github.com:pixielity/contracts.git
          - name: exceptions
            path: src/Exceptions
            repo: git@github.com:pixielity/exceptions.git
          - name: foundation
            path: src/Foundation
            repo: git@github.com:pixielity/foundation.git
          - name: package-a
            path: src/PackageA
            repo: git@github.com:pixielity/package-a.git
          - name: package-b
            path: src/PackageB
            repo: git@github.com:pixielity/package-b.git

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SPLIT_SSH_KEY }}

      - name: ğŸ”€ Split package - ${{ matrix.package.name }}
        uses: symplify/monorepo-split-github-action@v2.3.0
        with:
          package_directory: ${{ matrix.package.path }}
          repository_organization: pixielity
          repository_name: ${{ matrix.package.name }}
          user_name: "pixielity-bot"
          user_email: "bot@pixielity.com"
          branch: main

      - name: ğŸ·ï¸ Tag package - ${{ matrix.package.name }}
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd ${{ matrix.package.path }}
          git tag ${GITHUB_REF#refs/tags/}
          git push origin ${GITHUB_REF#refs/tags/}

  update-packagist-packages:
    name: ğŸ“¦ Update Packagist Packages
    runs-on: ubuntu-latest
    needs: split-packages
    if: startsWith(github.ref, 'refs/tags/')

    strategy:
      matrix:
        package:
          - pixielity/contracts
          - pixielity/exceptions
          - pixielity/foundation
          - pixielity/package-a
          - pixielity/package-b

    steps:
      - name: ğŸ“¦ Update ${{ matrix.package }} on Packagist
        run: |
          curl -XPOST -H'content-type:application/json' \
            "https://packagist.org/api/update-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
            -d'{"repository":{"url":"https://github.com/${{ matrix.package }}"}}'

      - name: âœ… Updated ${{ matrix.package }}
        run: echo "âœ… ${{ matrix.package }} updated on Packagist"
